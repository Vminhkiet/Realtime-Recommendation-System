FROM apache/airflow:2.9.0

USER root

# 1. C√†i ƒë·∫∑t Java (cho Spark) V√Ä Docker CLI (ƒë·ªÉ Airflow g·ªçi Spark)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    openjdk-17-jre-headless \
    docker.io \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 2. Thi·∫øt l·∫≠p bi·∫øn m√¥i tr∆∞·ªùng
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

# üî• [QUAN TR·ªåNG NH·∫§T] S·ª≠a l·ªói 127 cho user Root
# Ph·∫£i th√™m ':/home/airflow/.local/bin' v√†o PATH
ENV PATH="${JAVA_HOME}/bin:/home/airflow/.local/bin:${PATH}"

# 3. C·∫•p quy·ªÅn cho socket Docker (Ph√≤ng h·ªù l·ªói permission)
RUN groupadd -f docker && usermod -aG docker airflow
RUN chmod +x /usr/bin/docker

# 4. C√†i ƒë·∫∑t th∆∞ vi·ªán Python
COPY infra/airflow/requirements.txt /tmp/requirements.txt

USER airflow

RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    # Fix l·ªói Kafka c≈© (n·∫øu c√≥ d√πng)
    sed -i "s|from kafka.vendor.six.moves import range|from six.moves import range|" \
    /home/airflow/.local/lib/python3.*/site-packages/kafka/codec.py || true